=== Tomatillo Design AVIF Everywhere ===
Contributors: tomatillo-design
Requires at least: 6.1
Tested up to: 6.8
Requires PHP: 7.4
Stable tag: 1.1
License: GPLv2 or later
License URI: https://www.gnu.org/licenses/gpl-2.0.html
Tags: media, image optimization, avif, webp, performance, uploads

A developer-focused plugin that converts uploaded JPEG and PNG images to optimized AVIF (or WebP) format, applies them across the Media Library and editor interfaces, and includes smart fallbacks and UI enhancements for a modern WordPress experience.

== Description ==

**Tomatillo Design AVIF Everywhere** is a lightweight, developer-minded plugin that automatically converts images in your Media Library to the next-gen AVIF format. It improves site performance and media workflows while staying out of your way.

Behind the scenes, it uses the best available methods (Imagick or `avifenc`) to generate modern AVIF versions of your JPEG and PNG uploads. Transparent PNGs are handled intelligently, with automatic fallback to WebP if needed. Batch support is included for older uploads.

Thumbnails in the Media Library are enhanced to display AVIF images where available, with visual fixes for layout, scaling, and transparency.

== Features ==

- Converts JPEG and PNG uploads into AVIF format
- Transparent PNGs fallback to WebP when AVIF is unsupported or unstable
- Automatically runs on original or scaled versions depending on mode
- AVIF thumbnails displayed in the Media Library and media modals
- Graceful fallback to original formats if AVIF/WebP is unavailable or oversized
- Batch conversion support (manual trigger or cron-compatible)
- Media Library grid layout enhancements for clarity and usability
- Rate-limited checks to avoid overloading hosting environments

== How It Works ==

When an image is uploaded to your Media Library, the plugin schedules a short delay and then converts the image using either:

- PHP's Imagick extension (if AVIF is supported), or
- the `avifenc` command-line tool for lossless conversion (especially for PNGs)

If the AVIF version is larger than the WordPress-scaled JPEG, or if the image contains transparency that may not render correctly as AVIF, the plugin automatically falls back to WebP instead.

Only one optimized format is created per image — either AVIF (preferred) or WebP (fallback). This ensures maximum performance without clutter.

Media thumbnails and editor modals are updated on the fly to load AVIF or WebP images — but only after verifying the file exists on the server. This avoids unnecessary 404 errors and keeps your browser console clean.

== When You Deactivate or Delete ==

Disabling or deleting the plugin will:
- Stop automatic AVIF/WebP generation for new uploads
- Revert the Media Library and modal views to their default JPEG/PNG appearance

However, any `.avif` or `.webp` files already generated by the plugin **will remain** on your server. They are safe to leave in place, but if desired, you may manually remove them from the `/wp-content/uploads/` directory.

== Requirements ==

- WordPress 6.1 or higher
- PHP 7.4 or higher
- Imagick PHP extension with AVIF/WebP support **or** access to the `avifenc` CLI tool

== Frequently Asked Questions ==

= Does this plugin replace the original images? =
No. It generates `.avif` or `.webp` versions alongside your originals. The originals remain untouched.

= Will it work without Imagick or `avifenc`? =
No. At least one of these is required. The plugin will gracefully skip images if neither is available.

= Does it modify image URLs in content or templates? =
Yes — on the front end, the plugin dynamically replaces standard `<img>` tags with `<picture>` elements that include AVIF or WebP `<source>` tags (when supported by the browser and when valid files exist).

This helps reduce page weight and improve performance without requiring changes to your theme or post content.

= Can I batch-convert older uploads? =
Yes, batch conversion support is included and can be triggered manually or extended via custom cron jobs. The scan logic avoids duplicating work by skipping images that already have `.avif` or `.webp` versions.

== Screenshots ==
1. Media Library with AVIF thumbnails and masonry layout
2. Media inserter modal showing AVIF/WebP previews in the post editor

== Changelog ==

= 1.1 =
* Added WebP fallback for transparent PNGs or failed AVIF conversions
* Improved batch scanning logic to skip images with existing WebP or AVIF
* Refined transparency detection using Imagick for smarter decisions

= 1.0 =
* Initial release
* AVIF generation on upload
* Transparent PNG support with fallback
* Media Library and modal AVIF preview
* Dynamic layout improvements
* Throttled file existence checks to avoid rate limiting

== Upgrade Notice ==

= 1.1 =
Upgrade recommended. Adds WebP fallback and smarter batch handling to avoid redundant conversions.
